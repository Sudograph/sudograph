<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Migrations - Sudograph</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="sudograph.html"><strong aria-hidden="true">1.</strong> Sudograph</a></li><li class="chapter-item expanded "><a href="vision-and-motivation.html"><strong aria-hidden="true">2.</strong> Vision and motivation</a></li><li class="chapter-item expanded "><a href="examples.html"><strong aria-hidden="true">3.</strong> Examples</a></li><li class="chapter-item expanded "><a href="quickest-of-quick-starts.html"><strong aria-hidden="true">4.</strong> Quickest of quick starts</a></li><li class="chapter-item expanded "><a href="quick-start.html"><strong aria-hidden="true">5.</strong> Quick start</a></li><li class="chapter-item expanded "><a href="existing-project.html"><strong aria-hidden="true">6.</strong> Existing project</a></li><li class="chapter-item expanded "><a href="local-deployment.html"><strong aria-hidden="true">7.</strong> Local deployment</a></li><li class="chapter-item expanded "><a href="ic-deployment.html"><strong aria-hidden="true">8.</strong> IC deployment</a></li><li class="chapter-item expanded "><a href="wasm-binary-optimization.html"><strong aria-hidden="true">9.</strong> Wasm binary optimization</a></li><li class="chapter-item expanded "><a href="sudograph-client.html"><strong aria-hidden="true">10.</strong> Sudograph Client</a></li><li class="chapter-item expanded "><a href="agent-js.html"><strong aria-hidden="true">11.</strong> agent-js</a></li><li class="chapter-item expanded "><a href="schema.html"><strong aria-hidden="true">12.</strong> Schema</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="schema-scalars.html"><strong aria-hidden="true">12.1.</strong> Scalars</a></li><li class="chapter-item expanded "><a href="schema-enums.html"><strong aria-hidden="true">12.2.</strong> Enums</a></li><li class="chapter-item expanded "><a href="schema-objects.html"><strong aria-hidden="true">12.3.</strong> Objects</a></li><li class="chapter-item expanded "><a href="schema-relations.html"><strong aria-hidden="true">12.4.</strong> Relations</a></li><li class="chapter-item expanded "><a href="schema-custom-scalars.html"><strong aria-hidden="true">12.5.</strong> Custom scalars</a></li><li class="chapter-item expanded "><a href="schema-custom-resolvers.html"><strong aria-hidden="true">12.6.</strong> Custom resolvers</a></li><li class="chapter-item expanded "><a href="schema-custom-directives.html"><strong aria-hidden="true">12.7.</strong> Custom directives</a></li><li class="chapter-item expanded "><a href="schema-sudograph-directives.html"><strong aria-hidden="true">12.8.</strong> Sudograph directives</a></li><li class="chapter-item expanded "><a href="schema-sudograph-settings.html"><strong aria-hidden="true">12.9.</strong> Sudograph settings</a></li></ol></li><li class="chapter-item expanded "><a href="generated-schema.html"><strong aria-hidden="true">13.</strong> Generated schema</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="generated-schema-query.html"><strong aria-hidden="true">13.1.</strong> Query</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="generated-schema-query-read.html"><strong aria-hidden="true">13.1.1.</strong> read</a></li></ol></li><li class="chapter-item expanded "><a href="generated-schema-mutation.html"><strong aria-hidden="true">13.2.</strong> Mutation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="generated-schema-mutation-create.html"><strong aria-hidden="true">13.2.1.</strong> create</a></li><li class="chapter-item expanded "><a href="generated-schema-mutation-update.html"><strong aria-hidden="true">13.2.2.</strong> update</a></li><li class="chapter-item expanded "><a href="generated-schema-mutation-delete.html"><strong aria-hidden="true">13.2.3.</strong> delete</a></li><li class="chapter-item expanded "><a href="generated-schema-mutation-init.html"><strong aria-hidden="true">13.2.4.</strong> init</a></li></ol></li><li class="chapter-item expanded "><a href="generated-schema-subscription.html"><strong aria-hidden="true">13.3.</strong> Subscription</a></li><li class="chapter-item expanded "><a href="generated-schema-search.html"><strong aria-hidden="true">13.4.</strong> Search</a></li><li class="chapter-item expanded "><a href="generated-schema-limit.html"><strong aria-hidden="true">13.5.</strong> Limit</a></li><li class="chapter-item expanded "><a href="generated-schema-offset.html"><strong aria-hidden="true">13.6.</strong> Offset</a></li><li class="chapter-item expanded "><a href="generated-schema-order.html"><strong aria-hidden="true">13.7.</strong> Order</a></li></ol></li><li class="chapter-item expanded "><a href="authorization.html"><strong aria-hidden="true">14.</strong> Authorization</a></li><li class="chapter-item expanded "><a href="migrations.html" class="active"><strong aria-hidden="true">15.</strong> Migrations</a></li><li class="chapter-item expanded "><a href="transactions.html"><strong aria-hidden="true">16.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="multi-canister-scaling.html"><strong aria-hidden="true">17.</strong> Multi-canister scaling</a></li><li class="chapter-item expanded "><a href="custom-database-operations.html"><strong aria-hidden="true">18.</strong> Custom database operations</a></li><li class="chapter-item expanded "><a href="custom-async-graphql-integration.html"><strong aria-hidden="true">19.</strong> Custom async_graphql integration</a></li><li class="chapter-item expanded "><a href="limitations.html"><strong aria-hidden="true">20.</strong> Limitations</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Sudograph</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="migrations"><a class="header" href="#migrations">Migrations</a></h1>
<p>Whenever you wish to make changes to a canister without losing that canister's state, you must perform what is called an <a href="https://sdk.dfinity.org/docs/developers-guide/working-with-canisters.html#upgrade-canister">upgrade</a>.</p>
<p>An <code>upgrade</code> allows you to preserve your canister's state while changing its code. You can see a full example of an upgrade <a href="https://github.com/sudograph/sudograph/blob/main/examples/files/canisters/graphql/src/graphql.rs">here</a>.</p>
<h2 id="simple-migrations"><a class="header" href="#simple-migrations">Simple migrations</a></h2>
<p>If you haven't changed your schema and you just want to preserve state across upgrades:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use sudograph;

sudograph::graphql_database!(&quot;canisters/graphql/src/schema.graphql&quot;);

#[sudograph::ic_cdk_macros::pre_upgrade]
fn pre_upgrade_custom() {
    let object_type_store = sudograph::ic_cdk::storage::get::&lt;ObjectTypeStore&gt;();

    sudograph::ic_cdk::storage::stable_save((object_type_store,));
}

#[sudograph::ic_cdk_macros::post_upgrade]
fn post_upgrade_custom() {
    let (stable_object_type_store,): (ObjectTypeStore,) = sudograph::ic_cdk::storage::stable_restore().expect(&quot;ObjectTypeStore should be in stable memory&quot;);

    let object_type_store = sudograph::ic_cdk::storage::get_mut::&lt;ObjectTypeStore&gt;();

    for (key, value) in stable_object_type_store.into_iter() {
        object_type_store.insert(key, value);
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>The <code>upgrade</code> shown above assumes no changes to your GraphQL schema. If you were to change your GraphQL schema and then perform the <code>upgrade</code>, you would run into a number of issues. This is because the <a href="./custom-database-operations.html#objecttypestore">underlying data structures</a> that make up your database would be out of sync with your schema. In this case your code would cease to function as intended.</p>
<p>You must perform automatic or manual migrations on your code if you change your schema.</p>
<h2 id="automatic-migrations"><a class="header" href="#automatic-migrations">Automatic migrations</a></h2>
<p>Automatic migrations are not currently supported. For now you'll need to manually change the <code>ObjectTypeStore</code> in your <code>post_upgrade</code> function to reflect the changes in your schema, or accept that you will lose all of your state on every deploy (this may be acceptable if you plan on only deploying once).</p>
<p>The plan is to eventually automate migrations as much as possible. With automatic migrations, if you change your schema and wish to update it on a live canister, Sudograph will generate migrations written in Rust to accomplish the migration for you. If a migration cannot be performed automatically, Sudograph will allow you to easily define your own migration code in Rust. That's the rough plan for now.</p>
<h2 id="manual-migrations"><a class="header" href="#manual-migrations">Manual migrations</a></h2>
<p>Even with automatic migrations, you will run into scenarios that cannot be handled automatically. You may be required to manually update the <code>ObjectTypeStore</code> in the <code>post_upgrade</code> function to fully migrate data after schema changes. Studying <a href="./custom-database-operations.html#objecttypestore">the documentation available for the ObjectTypeStore</a> will help you determine what needs to be changed within it when you change your schema.</p>
<p>Let's look at the migrations required when we add a field to an object type in our schema. Here's the original schema:</p>
<pre><code class="language-graphql">type User {
    id: ID!
}
</code></pre>
<p>Imagine that we have deployed the original schema. Now we will change the schema:</p>
<pre><code class="language-graphql">type User {
    id: ID!
    username: String
}
</code></pre>
<p>We need to change the <code>ObjectTypeStore</code> so that it is aware of the change. In our <code>post_upgrade</code> function:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[sudograph::ic_cdk_macros::post_upgrade]
fn post_upgrade_custom() {
    let (stable_object_type_store,): (ObjectTypeStore,) = sudograph::ic_cdk::storage::stable_restore().expect(&quot;ObjectTypeStore should be in stable memory&quot;);

    let object_type_store = sudograph::ic_cdk::storage::get_mut::&lt;ObjectTypeStore&gt;();

    for (key, value) in stable_object_type_store.into_iter() {
        object_type_store.insert(key, value);
    }

    // First grab the object type for User
    let user_object_type = object_type_store.get_mut(&quot;User&quot;).expect(&quot;User object type should exist&quot;);

    // Then add the type information for the username field
    user_object_type.field_types_store.insert(
        &quot;username&quot;.to_string(),
        sudograph::sudodb::FieldType::String
    );

    // Finally add the initial values for the username field
    for field_value_store in user_object_type.field_values_store.values_mut() {
        field_value_store.insert(
            &quot;username&quot;.to_string(),
            sudograph::sudodb::FieldValue::Scalar(None)
        );
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>After the next deploy we will have successfully migrated our database! Make sure to remove the code on subsequent deploys. Automatic migrations will make this process simpler and more standardized.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="authorization.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="transactions.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="authorization.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="transactions.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="src/graphql-theme.js"></script>
        

        

    </body>
</html>
